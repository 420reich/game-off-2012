/*! FightCode - v0.1.0 - 2012-11-14
* http://fightcodega.me/
*/
var ANG_INCREMENT,Arena,BulletStatus,ElementStatus,Engine,MOVE_INCREMENT,RobotActions,RobotStatus,Vector2,WallStatus,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__slice=[].slice;MOVE_INCREMENT=1,ANG_INCREMENT=1,Vector2=function(){function e(t,n){this.x=t,this.y=n,this.x instanceof e&&(this.y=this.x.y,this.x=this.x.x)}return e.prototype.rotate=function(e,t){var n,r;return n=t.x+(this.x-t.x)*Math.cos(e)-(this.y-t.y)*Math.sin(e),r=t.y+(this.y-t.y)*Math.cos(e)-(this.x-t.x)*Math.cos(e),this},e.add=function(t,n){return new e(t.x+n.x,t.y+n.y)},e.subtract=function(t,n){return new e(t.x-n.x,t.y-n.y)},e}(),RobotActions=function(){function e(){this.queue=[]}return e.prototype.move=function(e,t){var n,r;for(n=1,r=e/MOVE_INCREMENT;1<=r?n<=r:n>=r;1<=r?n++:n--)this.queue.push({action:"move",direction:t});return!0},e.prototype.ahead=function(e){return this.move(e,1)},e.prototype.back=function(e){return this.move(e,-1)},e.prototype.rotateCannon=function(e){var t,n,r;r=[];for(t=1,n=e/ANG_INCREMENT;1<=n?t<=n:t>=n;1<=n?t++:t--)r.push(this.queue.push({action:"rotateCannon",direction:e}));return r},e.prototype.turn=function(e){var t,n,r;r=[];for(t=1,n=e/ANG_INCREMENT;1<=n?t<=n:t>=n;1<=n?t++:t--)r.push(this.queue.push({action:"turn",direction:e}));return r},e.prototype.fire=function(e){return this.queue.push({action:"fire"})},e}(),Arena=function(){function e(e,t){this.width=e,this.height=t,this.walls=[new WallStatus(this.width/2,0,this.width,1),new WallStatus(this.width,this.height/2,1,this.height),new WallStatus(this.width/2,this.height,this.width,1),new WallStatus(0,this.height/2,1,this.height)]}return e}(),ElementStatus=function(){function e(){this.id="element"+RobotStatus.id++,this.angle=0,this.position=new Vector2,this.dimension={width:1,height:1}}return e.id=1,e.prototype.top=function(){return this.position.y-this.dimension.height/2},e.prototype.left=function(){return this.position.x-this.dimension.width/2},e.prototype.right=function(){return this.position.x+this.dimension.width/2},e.prototype.bottom=function(){return this.position.y+this.dimension.height/2},e.prototype.isAlive=function(){return!0},e.prototype.upperRightCorner=function(){return(new Vector2(this.right(),this.top())).rotate(this.angle,this.position)},e.prototype.upperLeftCorner=function(){return(new Vector2(this.left(),this.top())).rotate(this.angle,this.position)},e.prototype.lowerLeftCorner=function(){return(new Vector2(this.left(),this.bottom())).rotate(this.angle,this.position)},e.prototype.lowerRightCorner=function(){return(new Vector2(this.right(),this.bottom())).rotate(this.angle,this.position)},e.prototype.intersects=function(e){var t,n,r,i;n=[Vector2.subtract(this.upperRightCorner(),this.upperLeftCorner()),Vector2.subtract(this.upperRightCorner(),this.lowerRightCorner()),Vector2.subtract(e.upperRightCorner(),e.upperLeftCorner()),Vector2.subtract(e.upperRightCorner(),e.lowerRightCorner())];for(r=0,i=n.length;r<i;r++){t=n[r];if(!this.isAxisCollision(e,t))return!1}return!0},e.prototype.isAxisCollision=function(e,t){var n,r,i,s,o,u;return o=[this.generateScalar(this.upperLeftCorner(),t),this.generateScalar(this.upperRightCorner(),t),this.generateScalar(this.lowerLeftCorner(),t),this.generateScalar(this.lowerRightCorner(),t)],u=[this.generateScalar(e.upperLeftCorner(),t),this.generateScalar(e.upperRightCorner(),t),this.generateScalar(e.lowerLeftCorner(),t),this.generateScalar(e.lowerRightCorner(),t)],i=Math.min.apply(Math,o),n=Math.max.apply(Math,o),s=Math.min.apply(Math,u),r=Math.max.apply(Math,u),i<=r&&n>=r?!0:s<=n&&r>=n?!0:!1},e.prototype.generateScalar=function(e,t){var n,r,i,s;return i=e.x*t.x+e.y*t.y,n=t.x*t.x+t.y*t.y,r=i/n,s=new Vector2(r*t.x,r*t.y),t.x*s.x+t.y*s.y},e}(),WallStatus=function(e){function t(e,n,r,i){t.__super__.constructor.call(this),this.position.x=e,this.position.y=n,this.dimension.width=r,this.dimension.height=i}return __extends(t,e),t}(ElementStatus),BulletStatus=function(e){function t(e){var n,r;this.robotStatus=e,t.__super__.constructor.call(this),this.angle=(this.robotStatus.angle+this.robotStatus.cannonAngle)%360,this.angleRad=this.angle*Math.PI/180,n=Math.cos(this.angleRad)*(this.robotStatus.dimension.width/2),r=Math.sin(this.angleRad)*(this.robotStatus.dimension.height/2),this.position.x=this.robotStatus.position.x+n,this.position.y=this.robotStatus.position.y+r,this.speed=5,this.strength=1,this.running=!0}return __extends(t,e),t.prototype.isIdle=function(){return!1},t.prototype.isAlive=function(){return this.running},t.prototype.runItem=function(){return this.position.x+=Math.cos(this.angleRad)*this.speed,this.position.y+=Math.sin(this.angleRad)*this.speed},t.prototype.destroy=function(){return this.running=!1},t}(ElementStatus),RobotStatus=function(e){function t(e,n){this.robot=e,this.arena=n,t.__super__.constructor.call(this),this.life=100,this.cannonAngle=0,this.dimension={width:27,height:24},this.queue=[]}return __extends(t,e),t.prototype.isAlive=function(){return this.life>0},t.prototype.isIdle=function(){return this.queue.length===0},t.prototype.takeHit=function(e){return this.life-=e.strength,e.destroy()},t.prototype.rollbackAfterCollision=function(){this.previousPosition&&(this.position=this.previousPosition);if(this.previousAngle)return this.angle=this.previousAngle},t.prototype.runItem=function(){var e,t,n;t=this.queue.shift();if(!t)return null;e=1,t.direction&&t.direction<0&&(e=-1),this.previousPosition=null,this.previousAngle=null;switch(t.action){case"move":n=this.angle*Math.PI/180,this.previousPosition=new Vector2(this.position),this.position.x+=Math.cos(n)*MOVE_INCREMENT*e,this.position.y+=Math.sin(n)*MOVE_INCREMENT*e;break;case"rotateCannon":this.cannonAngle+=ANG_INCREMENT*e,this.cannonAngle=this.cannonAngle%360;break;case"turn":this.previousAngle=this.angle,this.angle+=ANG_INCREMENT*e,this.angle=this.angle%360;break;case"fire":return new BulletStatus(this)}return null},t.prototype.updateQueue=function(e){return this.queue=e.queue.concat(this.queue)},t}(ElementStatus),Engine=function(){function e(){var e,t,n,r;r=arguments[0],e=arguments[1],n=3<=arguments.length?__slice.call(arguments,2):[],this.robots=n,this.round=0,this.arena=new Arena(r,e),this.robotsStatus=function(){var e,n,r,i;r=this.robots,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(new RobotStatus(t,this.arena));return i}.call(this)}return e.prototype.isDraw=function(){return this.round>2e4},e.prototype.safeCall=function(){var e,t,n;t=arguments[0],e=arguments[1],n=3<=arguments.length?__slice.call(arguments,2):[];if(!t[e])return;return t[e].apply(t,n)},e.prototype.checkCollision=function(e){var t,n,r,i,s,o,u,a,f,l;t=new RobotActions,f=this.arena.walls;for(s=0,u=f.length;s<u;s++)i=f[s],e.intersects(i)&&(e.rollbackAfterCollision(),this.safeCall(e.robot,"onWallCollision",t));l=this.robotsStatus;for(o=0,a=l.length;o<a;o++){r=l[o];if(r===e||!r.isAlive())continue;e.intersects(r)&&(n="onRobotCollision",r instanceof BulletStatus?(n="onHitByBullet",e.takeHit(r)):e.rollbackAfterCollision(),this.safeCall(e.robot,n,t))}return t},e.prototype.checkSight=function(e){var t;return t=new RobotActions},e.prototype.fight=function(){var e,t,n,r,i,s,o,u,a;t=this.robotsStatus.length,n=[];while(t>1&&!this.isDraw()){this.round++,n.push(i={round:this.round,objects:[],events:[]}),t=0,a=this.robotsStatus;for(o=0,u=a.length;o<u;o++){s=a[o];if(!s.isAlive())continue;i.objects.push({type:s instanceof RobotStatus?"tank":"bullet",id:s.id,position:{x:s.position.x,y:s.position.y},dimension:{width:s.dimension.width,height:s.dimension.height},health:s.health,angle:s.angle,cannonAngle:s.cannonAngle}),s.isIdle()&&(e=new RobotActions,this.safeCall(s.robot,"onIdle",{robot:e}),s.updateQueue(e)),r=s.runItem(),r&&this.robotsStatus.push(r),s instanceof RobotStatus&&(t++,e=this.checkCollision(s),s.updateQueue(e),e=this.checkSight(s),s.updateQueue(e))}}return this.isDraw()&&this.isDraw()&&console.log("DRAW!"),n},e}();var SampleRobot;SampleRobot=function(){function e(){}return e.prototype.onIdle=function(e){var t;return t=e.robot,t.ahead(150),t.rotateCannon(360),t.back(100),t.rotateCannon(360),t.turn(20)},e.prototype.onRobotCollision=function(e){return console.log("onRobotCollision",e)},e.prototype.onWallCollision=function(e){},e.prototype.onScannedRobot=function(e){var t;return console.log("onScannedRobot",e),t=e.robot,t.fire(1)},e.prototype.onHitByBullet=function(e){var t;return console.log("onHitByBullet",e),t=e.robot,t.turn(90-e.bulletBearing)},e}();