/*! FightCode - v0.1.0
* http://fightcodega.me/
*/
var ANG_INCREMENT,Arena,BulletStatus,ElementStatus,Engine,MOVE_INCREMENT,PI2,RAD2DEG,Rectangle,RobotActions,RobotStatus,Vector2,WallStatus,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__slice=[].slice;MOVE_INCREMENT=1,ANG_INCREMENT=1,PI2=Math.PI*2,RAD2DEG=180/Math.PI,Vector2=function(){function e(t,n){this.x=t,this.y=n,this.x instanceof e&&(this.y=this.x.y,this.x=this.x.x)}return e.prototype.rotate=function(e,t){var n,r,i,s;return e=e*Math.PI/180,r=Math.sin(e),n=Math.cos(e),i=this.x-t.x,s=this.y-t.y,this.x=i*n-s*r+t.x,this.y=i*r+s*n+t.y,this},e.prototype.module=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.projectTo=function(t){var n,r,i;return i=this.x*t.x+this.y*t.y,n=t.x*t.x+t.y*t.y,r=i/n,new e(r*t.x,r*t.y)},e.add=function(t,n){return new e(t.x+n.x,t.y+n.y)},e.subtract=function(t,n){return new e(t.x-n.x,t.y-n.y)},e}(),RobotActions=function(){function e(e){this.id=e.id,this.angle=e.rectangle.angle,this.cannonAngle=e.cannonAngle,this.position=new Vector2(e.rectangle.position),this.life=e.life,this.queue=[]}return e.prototype.move=function(e,t){if(e===0)return;return this.queue.push({action:"move",direction:t,count:Math.abs(e)/MOVE_INCREMENT}),!0},e.prototype.ahead=function(e){return this.move(e,1)},e.prototype.back=function(e){return this.move(e,-1)},e.prototype.rotateCannon=function(e){if(e===0)return;return this.queue.push({action:"rotateCannon",direction:e,count:Math.abs(e)/ANG_INCREMENT})},e.prototype.turn=function(e){if(e===0)return;return this.queue.push({action:"turn",direction:e,count:Math.abs(e)/ANG_INCREMENT})},e.prototype.fire=function(e){return this.queue.push({action:"fire"})},e}(),Arena=function(){function e(e,t){this.width=e,this.height=t,this.walls=[new WallStatus(this.width/2,0,this.width,1),new WallStatus(this.width,this.height/2,1,this.height),new WallStatus(this.width/2,this.height,this.width,1),new WallStatus(0,this.height/2,1,this.height)]}return e}(),Rectangle=function(){function e(e,t,n,r,i){e==null&&(e=0),t==null&&(t=0),n==null&&(n=1),r==null&&(r=1),this.angle=i!=null?i:0,this.position=new Vector2(e,t),this.setDimension(n,r),this.updateCoords()}return e.prototype.setAngle=function(e){return this.angle=e,this.updateCoords()},e.prototype.setDimension=function(e,t){return this.dimension={width:e,height:t},this.halfWidth=e/2,this.halfHeight=t/2,this.radius=this.halfWidth+this.halfHeight,this.updateCoords()},e.prototype.setPosition=function(e,t){return this.position.x=e,this.position.y=t,this.updateCoords()},e.prototype.incPosition=function(e,t){return this.position.x+=e,this.position.y+=t,this.updateCoords()},e.prototype.updateCoords=function(){var e,t,n,r;return r=this.position.y-this.halfHeight,t=this.position.x-this.halfWidth,e=this.position.y+this.halfHeight,n=this.position.x+this.halfWidth,this.upperRight=(new Vector2(n,r)).rotate(this.angle,this.position),this.upperLeft=(new Vector2(t,r)).rotate(this.angle,this.position),this.lowerLeft=(new Vector2(t,e)).rotate(this.angle,this.position),this.lowerRight=(new Vector2(n,e)).rotate(this.angle,this.position)},e.prototype.intersects=function(e,t){var n,r,i,s,o;t==null&&(t=!0),i=Vector2.subtract(this.position,e.position).module();if(i>this.radius+e.radius)return!1;r=[Vector2.subtract(this.upperRight,this.upperLeft),Vector2.subtract(this.upperRight,this.lowerRight),Vector2.subtract(e.upperRight,e.upperLeft),Vector2.subtract(e.upperRight,e.lowerRight)];for(s=0,o=r.length;s<o;s++){n=r[s];if(!this.isAxisCollision(e,n))return!1}return!0},e.prototype.isAxisCollision=function(e,t){var n,r,i,s,o,u;return o=[this.generateScalar(this.upperLeft,t),this.generateScalar(this.upperRight,t),this.generateScalar(this.lowerLeft,t),this.generateScalar(this.lowerRight,t)],u=[this.generateScalar(e.upperLeft,t),this.generateScalar(e.upperRight,t),this.generateScalar(e.lowerLeft,t),this.generateScalar(e.lowerRight,t)],i=Math.min.apply(Math,o),n=Math.max.apply(Math,o),s=Math.min.apply(Math,u),r=Math.max.apply(Math,u),i<=r&&n>=r?!0:s<=n&&r>=n?!0:!1},e.prototype.generateScalar=function(e,t){var n;return n=e.projectTo(t),t.x*n.x+t.y*n.y},e}(),ElementStatus=function(){function e(){this.id="element"+RobotStatus.id++,this.rectangle=new Rectangle}return e.id=1,e.prototype.isAlive=function(){return!0},e}(),WallStatus=function(e){function t(e,n,r,i){t.__super__.constructor.call(this),this.rectangle.setPosition(e,n),this.rectangle.setDimension(r,i)}return __extends(t,e),t}(ElementStatus),BulletStatus=function(e){function t(e){var n,r,i;this.robotStatus=e,t.__super__.constructor.call(this),this.rectangle.setAngle((this.robotStatus.rectangle.angle+this.robotStatus.cannonAngle)%360),n=this.rectangle.angle*Math.PI/180,this.sinAngle=Math.sin(n),this.cosAngle=Math.cos(n),r=this.cosAngle*(this.robotStatus.rectangle.dimension.width/2),i=this.sinAngle*(this.robotStatus.rectangle.dimension.height/2),this.rectangle.setPosition(this.robotStatus.rectangle.position.x+r,this.robotStatus.rectangle.position.y+i),this.speed=2,this.strength=20,this.running=!0}return __extends(t,e),t.prototype.isIdle=function(){return!1},t.prototype.isAlive=function(){return this.running},t.prototype.runItem=function(){return this.previousPosition=new Vector2(this.rectangle.position),this.rectangle.incPosition(this.cosAngle*this.speed,this.sinAngle*this.speed),null},t.prototype.destroy=function(){return this.running=!1},t.prototype.rollbackAfterCollision=function(){if(this.previousPosition)return this.rectangle.setPosition(this.previousPosition.x,this.previousPosition.y)},t.prototype.updateQueue=function(){},t}(ElementStatus),RobotStatus=function(e){function t(e,n){this.robot=e,this.arena=n,t.__super__.constructor.call(this),this.life=100,this.cannonAngle=0,this.rectangle.setDimension(27,24),this.baseScanWaitTime=50,this.scanWaitTime=0,this.queue=[]}return __extends(t,e),t.prototype.isAlive=function(){return this.life>0},t.prototype.isIdle=function(){return this.queue.length===0},t.prototype.takeHit=function(e){return this.life-=e.strength,e.destroy()},t.prototype.rollbackAfterCollision=function(){this.previousPosition&&this.rectangle.setPosition(this.previousPosition.x,this.previousPosition.y);if(this.previousAngle)return this.rectangle.setAngle(this.previousAngle)},t.prototype.cannonTotalAngle=function(){return(this.rectangle.angle+this.cannonAngle)%360},t.prototype.canScan=function(){return this.scanWaitTime===0},t.prototype.tickScan=function(){if(this.scanWaitTime>0)return this.scanWaitTime-=1},t.prototype.preventScan=function(){return this.scanWaitTime=this.baseScanWaitTime},t.prototype.runItem=function(){var e,t,n,r;n=this.queue.shift();if(!n)return;"count"in n&&(n.count--,n.count>0&&this.queue.unshift(n)),t=1,n.direction&&n.direction<0&&(t=-1),this.previousPosition=null,this.previousAngle=null,this.previousCannonAngle=null;switch(n.action){case"move":r=this.rectangle.angle*Math.PI/180,this.previousPosition=new Vector2(this.rectangle.position),this.rectangle.incPosition(Math.cos(r)*MOVE_INCREMENT*t,Math.sin(r)*MOVE_INCREMENT*t);break;case"rotateCannon":this.previousCannonAngle=this.cannonAngl,this.cannonAngle+=ANG_INCREMENT*t,this.cannonAngle=this.cannonAngle%360;break;case"turn":this.previousAngle=this.rectangle.angle,e=this.previousAngle+ANG_INCREMENT*t,this.rectangle.setAngle(e%360);break;case"fire":return new BulletStatus(this)}return null},t.prototype.updateQueue=function(e){return this.queue=e.queue.concat(this.queue)},t}(ElementStatus),Engine=function(){function e(){var e,t,n,r,i;i=arguments[0],e=arguments[1],t=arguments[2],r=4<=arguments.length?__slice.call(arguments,3):[],this.maxTurns=t,this.robots=r,this.round=0,this.arena=new Arena(i,e),this.robotsStatus=function(){var e,t,r,i;r=this.robots,i=[];for(e=0,t=r.length;e<t;e++)n=r[e],i.push(new RobotStatus(n,this.arena));return i}.call(this)}return e.prototype.isDraw=function(){return this.round>this.maxTurns},e.prototype.safeCall=function(){var e,t,n;t=arguments[0],e=arguments[1],n=3<=arguments.length?__slice.call(arguments,2):[];if(!t[e])return;return t[e].apply(t,n)},e.prototype.checkCollision=function(e){var t,n,r,i,s,o,u,a,f,l,c;t=new RobotActions(e),l=this.arena.walls;for(o=0,a=l.length;o<a;o++)s=l[o],e.rectangle.intersects(s.rectangle,!1)&&(e.rollbackAfterCollision(),e instanceof BulletStatus?this.roundLog.events.push({type:"exploded",id:e.id}):this.safeCall(e.robot,"onWallCollision",{robot:t}));if(e instanceof BulletStatus)return t;c=this.robotsStatus;for(u=0,f=c.length;u<f;u++){i=c[u];if(i===e||!i.isAlive())continue;if(e.rectangle.intersects(i.rectangle)){r="onRobotCollision";if(i instanceof BulletStatus){if(i.robotStatus===e)continue;r="onHitByBullet",e.takeHit(i),this.roundLog.events.push({type:"exploded",id:i.id})}else e.rollbackAfterCollision();n=(i.rectangle.angle+180-e.rectangle.angle+360)%360,this.safeCall(e.robot,r,{robot:t,bulletBearing:n})}}return t},e.prototype.checkSight=function(e){var t,n,r,i,s,o,u,a,f;t=new RobotActions(e),o=2e3,i=1,n=new Vector2(e.rectangle.position.x+o/2,e.rectangle.position.y-i/2),n.rotate(e.cannonTotalAngle(),e.rectangle.position),s=new Rectangle(n.x,n.y,o,i,e.cannonTotalAngle()),e.tickScan(),f=this.robotsStatus;for(u=0,a=f.length;u<a;u++){r=f[u];if(r===e||!r.isAlive())continue;if(!(r instanceof RobotStatus))continue;e.canScan()&&s.intersects(r.rectangle)&&(e.preventScan(),this.safeCall(e.robot,"onScannedRobot",{robot:t}),this.roundLog.events.push({type:"onScannedRobot",id:e.id}))}return t},e.prototype.fight=function(){var e,t,n,r,i,s,o,u,a,f,l;t=this.robotsStatus.length,n=[];while(t>1&&!this.isDraw()){this.round++,n.push(this.roundLog={round:this.round,objects:[],events:[]}),t=0,f=this.robotsStatus;for(s=0,u=f.length;s<u;s++){i=f[s];if(!i.isAlive())continue;this.roundLog.objects.push({type:i instanceof RobotStatus?"tank":"bullet",id:i.id,position:{x:i.rectangle.position.x,y:i.rectangle.position.y},dimension:{width:i.rectangle.dimension.width,height:i.rectangle.dimension.height},life:i.life,angle:i.rectangle.angle,cannonAngle:i.cannonAngle}),i.isIdle()&&(e=new RobotActions(i),this.safeCall(i.robot,"onIdle",{robot:e}),i.updateQueue(e)),r=i.runItem(),r&&this.robotsStatus.push(r),e=this.checkCollision(i),i.updateQueue(e),i instanceof RobotStatus&&t++}l=this.robotsStatus;for(o=0,a=l.length;o<a;o++){i=l[o];if(!(i.isAlive()&&i instanceof RobotStatus))continue;e=this.checkSight(i),i.updateQueue(e)}}return{draw:this.isDraw(),result:n}},e}();var SampleRobot;SampleRobot=function(){function e(){}return e.prototype.onIdle=function(e){var t;return t=e.robot,t.ahead(100),t.rotateCannon(360),t.back(100),t.rotateCannon(360)},e.prototype.onRobotCollision=function(e){return console.log("onRobotCollision",e)},e.prototype.onWallCollision=function(e){},e.prototype.onScannedRobot=function(e){var t;return t=e.robot,t.fire(1)},e.prototype.onHitByBullet=function(e){var t;return t=e.robot,t.turn(e.bulletBearing)},e}();